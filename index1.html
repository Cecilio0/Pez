<!DOCTYPE html>
<html>
  <head>
    <title>Poissons Animés avec Paper.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-core.min.js"></script>
    <style>
      canvas {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <canvas id="fishCanvas" resize></canvas>
    <script>
      paper.setup("fishCanvas");

      // Fonction pour créer un poisson
      function createFish(position) {
        var fishBody = new paper.Path.Ellipse({
          center: position,
          radius: [40, 15], // Taille du corps du poisson
          fillColor: "fuchsia",
        });

        var fishTail = new paper.Path({
          segments: [
            [position.x - 40, position.y],
            [position.x - 60, position.y - 15],
            [position.x - 60, position.y + 15],
          ],
          fillColor: "fuchsia",
          closed: true,
        });

        var fishOuterEye = new paper.Path.Circle({
          center: [position.x + 25, position.y - 5],
          radius: 5,
          fillColor: "white",
        });

        var fishInnerEye = new paper.Path.Circle({
          center: [position.x + 25, position.y - 3],
          radius: 2.5,
          fillColor: "black",
        });

        var fishEye = new paper.Group([fishOuterEye, fishInnerEye]);

        var fishHat = new paper.Path({
          segments: [
            [position.x + 20, position.y - 15],
            [position.x + 20, position.y - 20],
            [position.x + 7.5, position.y - 20],
            [position.x + 7.5, position.y - 35],
            [position.x - 7.5, position.y - 35],
            [position.x - 7.5, position.y - 20],
            [position.x - 20, position.y - 20],
            [position.x - 20, position.y - 15],
          ],
          fillColor: "black",
          closed: true,
        });

        var fish = new paper.Group([fishBody, fishTail, fishEye, fishHat]);
        fish.pivot = fish.children[0].position;

        return fish;
      }

      // Fonction pour gérer le mouvement du poisson
      function moveFish(fish, targetPosition, speed) {
        let vector = targetPosition.subtract(fish.position);
        if (vector.length > 40) {
          fish.position = fish.position.add(vector.normalize(speed));
        }
      }

      // Fonction pour gérer la rotation des yeux du poisson
      function rotateEyes(fish, eyeRotation) {
        fish.children[2].children[1].rotate(
          eyeRotation,
          fish.children[2].position
        );
      }

      var mousePosition = new paper.Point(0, 0);

      paper.view.onMouseMove = function (event) {
        mousePosition = event.point;
      };

      // Nombre de poissons à afficher
      var numFish = 3;

      // Tableau pour stocker les poissons
      var fishes = [];

      // Création des poissons
      for (let i = 0; i < numFish; i++) {
        fishes.push(createFish(new paper.Point(200 + i * 200, 200)));
      }

      var fishSpeed = 1;
      var previousFishRotations = new Array(numFish).fill(0);
      var eyeRotations = new Array(numFish).fill(0);
      var tailSwingDirections = new Array(numFish).fill(1);
      var fishTailAxes = new Array(numFish);

      paper.view.onFrame = function (event) {
        for (let i = 0; i < numFish; i++) {
          // Déplacer le poisson
          moveFish(fishes[i], mousePosition, fishSpeed);

          // Calculer la rotation et faire tourner les yeux du poisson
          let vector = mousePosition.subtract(fishes[i].position);
          let unitVector = vector.normalize();
          let currentFishRotation = unitVector.angle;
          fishes[i].rotation = currentFishRotation - previousFishRotations[i];
          eyeRotations[i] = previousFishRotations[i] - currentFishRotation;
          previousFishRotations[i] = currentFishRotation;
          rotateEyes(fishes[i], eyeRotations[i]);

          if (event.count % 10 === 0) {
            // Faire balancer la queue du poisson
            fishTailAxes[i] = unitVector.multiply(40);
            fishes[i].children[1].rotate(
              tailSwingDirections[i] * 15,
              fishes[i].children[0].position.subtract(fishTailAxes[i])
            );
            tailSwingDirections[i] *= -1;
          }

          // Réinitialiser la position si le poisson sort de l'écran
          if (fishes[i].bounds.left > paper.view.bounds.width) {
            fishes[i].position.x = -fishes[i].bounds.width;
          }
        }
      };
    </script>
  </body>
</html>
